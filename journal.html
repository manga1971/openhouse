<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LumiYE – Jurnal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Stiluri generale conform filosofiei de design */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #FDFBF6; /* Fundal bej cald */
      color: #2E2E2E; /* Text gri foarte închis */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between; /* Spațiază elementele pe verticală */
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
    /* Stil pentru bara de progres */
    .progress-bar-container {
      @apply w-full max-w-md bg-gray-200 rounded-full h-2.5 mb-8;
    }
    .progress-bar {
      @apply bg-blue-300 h-2.5 rounded-full; /* Albastru-pal pentru progres */
      transition: width 0.5s ease-in-out;
    }
    /* Stil pentru zona de transcriere */
    .transcript-area {
      @apply flex-grow w-full max-w-2xl bg-white/50 backdrop-blur-sm border border-white/30 rounded-xl shadow-lg p-6 overflow-y-auto;
      min-height: 200px; /* Înălțime minimă pentru zona de transcriere */
      max-height: 60vh; /* Înălțime maximă pentru a permite scroll */
    }
    /* Stil pentru microfonul animat */
    .microphone-button {
      @apply w-24 h-24 rounded-full flex items-center justify-center cursor-pointer shadow-lg;
      background-color: #C7EDE6; /* Verde mentă soft pentru buton */
      transition: transform 0.2s ease-in-out;
      margin-top: 20px; /* Spațiu deasupra butonului */
    }
    .microphone-button:active {
      transform: scale(0.95);
    }
    /* Animație subtilă pentru propozițiile care apar */
    .sentence-pop-in {
      animation: popIn 0.5s ease-out forwards;
      opacity: 0;
      transform: translateY(10px);
    }
    @keyframes popIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <!-- Bara de progres a sesiunii -->
  <div class="progress-bar-container">
    <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
  </div>

  <!-- Zona de transcriere live -->
  <div id="transcriptArea" class="transcript-area text-lg leading-relaxed">
    <p class="text-gray-500 text-center italic">Vorbește liber. LumiYE te ascultă...</p>
  </div>

  <!-- Butonul de microfon și mesajul de încurajare -->
  <div class="flex flex-col items-center mt-6">
    <div id="microphoneButton" class="microphone-button">
      <span class="text-4xl">🎙️</span>
    </div>
    <p id="recordingStatus" class="mt-4 text-gray-600 text-center">Înregistrează ce simți azi.</p>
  </div>

  <script>
    const microphoneButton = document.getElementById('microphoneButton');
    const recordingStatus = document.getElementById('recordingStatus');
    const transcriptArea = document.getElementById('transcriptArea');
    const progressBar = document.getElementById('progressBar');

    let recognition; // Variabila pentru Web Speech API
    let isRecording = false;
    let startTime;
    const maxRecordingTime = 120; // 2 minute în secunde
    let recordingInterval;
    let currentTranscript = ''; // Stochează transcrierea curentă
    let sentenceCount = 0; // Contor pentru numărul de propoziții

    // Funcție pentru a simula analiza NLP (simplificată pentru MVP)
    function analyzeText(text) {
      const positiveWords = ['bucurie', 'speranță', 'fericit', 'mulțumit', 'recunoștință', 'curaj', 'potențial', 'vreau', 'succes'];
      const negativeWords = ['nu pot', 'blocat', 'singur', 'eșec', 'trist', 'copleșit', 'stres', 'îndoieli', 'obosit'];

      let positives = 0;
      let negatives = 0;

      const lowerCaseText = text.toLowerCase();

      positiveWords.forEach(word => {
        if (lowerCaseText.includes(word)) {
          positives++;
        }
      });
      negativeWords.forEach(word => {
        if (lowerCaseText.includes(word)) {
          negatives++;
        }
      });

      // Detectarea intențiilor simplificate
      let intentii = [];
      if (lowerCaseText.includes('nu mai vreau să fiu')) {
        intentii.push(`"nu mai vreau să fiu..." → evitare`);
      }
      if (lowerCaseText.includes('vreau să devin')) {
        intentii.push(`"vreau să devin..." → progres`);
      }

      return { positives, negatives, intentii };
    }

    // Funcție pentru a simula analiza respirației (WPM și pauze)
    function analyzeBreathing(text, durationInSeconds) {
      const words = text.split(/\s+/).filter(word => word.length > 0);
      const wordCount = words.length;
      const wpm = durationInSeconds > 0 ? (wordCount / durationInSeconds) * 60 : 0;

      // O simulare foarte simplificată a pauzelor, bazată pe punctuație
      const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0);
      const averageSentenceLength = sentences.length > 0 ? wordCount / sentences.length : 0;

      let breathingFeedback = '';
      if (wpm > 180) { // Prag arbitrar pentru ritm rapid
        breathingFeedback = 'Ai vorbit într-un ritm rapid azi.';
      } else if (wpm < 80 && wpm > 0) { // Prag arbitrar pentru ritm lent
        breathingFeedback = 'Ai un ritm de vorbire calm.';
      }

      if (sentences.length > 1 && averageSentenceLength < 5) { // Propoziții scurte pot indica pauze frecvente sau agitație
         breathingFeedback += ' Pauzele scurte pot semnala agitație.';
      } else if (sentences.length > 1 && averageSentenceLength > 15) { // Propoziții lungi pot indica un flux coerent
         breathingFeedback += ' Fluxul coerent al vorbirii.';
      }

      return { wpm: wpm.toFixed(0), breathingFeedback };
    }


    // Funcția pentru a începe înregistrarea
    function startRecording() {
      if (!('webkitSpeechRecognition' in window)) {
        recordingStatus.textContent = 'API-ul de recunoaștere vocală nu este suportat de browserul tău.';
        return;
      }

      recognition = new webkitSpeechRecognition();
      recognition.continuous = true; // Continuă să asculte
      recognition.interimResults = true; // Afișează rezultate provizorii
      recognition.lang = 'ro-RO'; // Setează limba la română

      let finalTranscript = ''; // Stochează transcrierea finală pentru sesiune

      recognition.onstart = () => {
        isRecording = true;
        startTime = Date.now();
        recordingStatus.textContent = '🎙️ Ascult...';
        transcriptArea.innerHTML = '<p class="text-gray-500 text-center italic">Vorbește liber. LumiYE te ascultă...</p>'; // Curăță la început
        currentTranscript = ''; // Resetează transcrierea la începutul unei noi sesiuni

        // Actualizează bara de progres la fiecare secundă
        recordingInterval = setInterval(() => {
          const elapsed = (Date.now() - startTime) / 1000;
          const progress = (elapsed / maxRecordingTime) * 100;
          progressBar.style.width = `${Math.min(progress, 100)}%`;

          if (elapsed >= maxRecordingTime) {
            stopRecording(); // Oprește înregistrarea după timpul maxim
          }
        }, 1000);
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript + '. '; // Adaugă un punct la finalul propoziției
            // Adaugă propoziția finală în zona de transcriere cu animație
            const p = document.createElement('p');
            p.textContent = event.results[i][0].transcript;
            p.classList.add('sentence-pop-in');
            transcriptArea.appendChild(p);
            transcriptArea.scrollTop = transcriptArea.scrollHeight; // Scrollează automat
            currentTranscript = finalTranscript; // Actualizează transcrierea curentă
            sentenceCount++;

          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        // Poți afișa interimTranscript separat dacă vrei feedback instant, dar pentru simplitate, ne concentrăm pe finalTranscript
      };

      recognition.onerror = (event) => {
        console.error('Eroare recunoaștere vocală:', event.error);
        recordingStatus.textContent = `Eroare: ${event.error}. Te rugăm să încerci din nou.`;
        isRecording = false;
        clearInterval(recordingInterval);
      };

      recognition.onend = () => {
        if (isRecording) { // Doar dacă nu a fost oprită manual
          isRecording = false;
          clearInterval(recordingInterval);
          recordingStatus.textContent = 'Înregistrare încheiată. Analizăm...';
          processSession(finalTranscript); // Procesează sesiunea la final
        }
      };

      recognition.start();
    }

    // Funcția pentru a opri înregistrarea
    function stopRecording() {
      if (isRecording) {
        recognition.stop();
        isRecording = false;
        clearInterval(recordingInterval);
        recordingStatus.textContent = 'Înregistrare încheiată. Analizăm...';
        processSession(currentTranscript); // Procesează sesiunea
      }
    }

    // Funcția principală de procesare a sesiunii
    function processSession(transcript) {
      const duration = (Date.now() - startTime) / 1000; // Durata sesiunii în secunde
      const { positives, negatives, intentii } = analyzeText(transcript);
      const { wpm, breathingFeedback } = analyzeBreathing(transcript, duration);

      const sessionData = {
        time: new Date().toLocaleString('ro-RO', { dateStyle: 'medium', timeStyle: 'short' }),
        transcript: transcript,
        duration: duration.toFixed(0), // Durata în secunde
        analysis: {
          positives: positives,
          negatives: negatives,
          highWords: [], // Acestea vor fi populate mai târziu cu cuvinte cheie reale
          lowWords: [], // Acestea vor fi populate mai târziu cu cuvinte cheie reale
          intentii: intentii,
          wpm: wpm,
          breathingFeedback: breathingFeedback
        }
      };

      // Salvăm datele sesiunii în localStorage pentru a fi accesibile în reports.html
      // Aici nu mai salvăm direct, ci trimitem la pagina de feedback
      localStorage.setItem('current_session_data', JSON.stringify(sessionData));

      // Redirecționăm către pagina de feedback
      window.location.href = 'feedback.html';
    }

    // Ascultă evenimentul de click pe butonul de microfon
    microphoneButton.addEventListener('click', () => {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    });

    // La încărcarea paginii, dacă venim de la home, pornim automat înregistrarea
    window.onload = () => {
      // Verificăm dacă am venit de pe pagina principală (simulare)
      // În aplicația reală, ai putea folosi un parametru URL sau sessionStorage
      const referrer = document.referrer;
      if (referrer.includes('index.html')) {
        startRecording();
      }
    };
  </script>
</body>
</html>

