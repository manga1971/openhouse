<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LumiYE â€“ Jurnal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Stiluri generale conform filosofiei de design */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #FDFBF6; /* Fundal bej cald */
      color: #2E2E2E; /* Text gri foarte Ã®nchis */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between; /* SpaÈ›iazÄƒ elementele pe verticalÄƒ */
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
    /* Stil pentru bara de progres */
    .progress-bar-container {
      @apply w-full max-w-md bg-gray-200 rounded-full h-2.5 mb-8;
    }
    .progress-bar {
      @apply bg-blue-300 h-2.5 rounded-full; /* Albastru-pal pentru progres */
      transition: width 0.5s ease-in-out;
    }
    /* Stil pentru zona de transcriere */
    .transcript-area {
      @apply flex-grow w-full max-w-2xl bg-white/50 backdrop-blur-sm border border-white/30 rounded-xl shadow-lg p-6 overflow-y-auto;
      min-height: 200px; /* ÃnÄƒlÈ›ime minimÄƒ pentru zona de transcriere */
      max-height: 60vh; /* ÃnÄƒlÈ›ime maximÄƒ pentru a permite scroll */
    }
    /* Stil pentru microfonul animat */
    .microphone-button {
      @apply w-24 h-24 rounded-full flex items-center justify-center cursor-pointer shadow-lg;
      background-color: #C7EDE6; /* Verde mentÄƒ soft pentru buton */
      transition: transform 0.2s ease-in-out;
      margin-top: 20px; /* SpaÈ›iu deasupra butonului */
    }
    .microphone-button:active {
      transform: scale(0.95);
    }
    /* AnimaÈ›ie subtilÄƒ pentru propoziÈ›iile care apar */
    .sentence-pop-in {
      animation: popIn 0.5s ease-out forwards;
      opacity: 0;
      transform: translateY(10px);
    }
    @keyframes popIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <!-- Bara de progres a sesiunii -->
  <div class="progress-bar-container">
    <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
  </div>

  <!-- Zona de transcriere live -->
  <div id="transcriptArea" class="transcript-area text-lg leading-relaxed">
    <p class="text-gray-500 text-center italic">VorbeÈ™te liber. LumiYE te ascultÄƒ...</p>
  </div>

  <!-- Butonul de microfon È™i mesajul de Ã®ncurajare -->
  <div class="flex flex-col items-center mt-6">
    <div id="microphoneButton" class="microphone-button">
      <span class="text-4xl">ğŸ™ï¸</span>
    </div>
    <p id="recordingStatus" class="mt-4 text-gray-600 text-center">ÃnregistreazÄƒ ce simÈ›i azi.</p>
  </div>

  <script>
    const microphoneButton = document.getElementById('microphoneButton');
    const recordingStatus = document.getElementById('recordingStatus');
    const transcriptArea = document.getElementById('transcriptArea');
    const progressBar = document.getElementById('progressBar');

    let recognition; // Variabila pentru Web Speech API
    let isRecording = false;
    let startTime;
    const maxRecordingTime = 120; // 2 minute Ã®n secunde
    let recordingInterval;
    let currentTranscript = ''; // StocheazÄƒ transcrierea curentÄƒ
    let sentenceCount = 0; // Contor pentru numÄƒrul de propoziÈ›ii

    // FuncÈ›ie pentru a simula analiza NLP (simplificatÄƒ pentru MVP)
    function analyzeText(text) {
      const positiveWords = ['bucurie', 'speranÈ›Äƒ', 'fericit', 'mulÈ›umit', 'recunoÈ™tinÈ›Äƒ', 'curaj', 'potenÈ›ial', 'vreau', 'succes'];
      const negativeWords = ['nu pot', 'blocat', 'singur', 'eÈ™ec', 'trist', 'copleÈ™it', 'stres', 'Ã®ndoieli', 'obosit'];

      let positives = 0;
      let negatives = 0;

      const lowerCaseText = text.toLowerCase();

      positiveWords.forEach(word => {
        if (lowerCaseText.includes(word)) {
          positives++;
        }
      });
      negativeWords.forEach(word => {
        if (lowerCaseText.includes(word)) {
          negatives++;
        }
      });

      // Detectarea intenÈ›iilor simplificate
      let intentii = [];
      if (lowerCaseText.includes('nu mai vreau sÄƒ fiu')) {
        intentii.push(`"nu mai vreau sÄƒ fiu..." â†’ evitare`);
      }
      if (lowerCaseText.includes('vreau sÄƒ devin')) {
        intentii.push(`"vreau sÄƒ devin..." â†’ progres`);
      }

      return { positives, negatives, intentii };
    }

    // FuncÈ›ie pentru a simula analiza respiraÈ›iei (WPM È™i pauze)
    function analyzeBreathing(text, durationInSeconds) {
      const words = text.split(/\s+/).filter(word => word.length > 0);
      const wordCount = words.length;
      const wpm = durationInSeconds > 0 ? (wordCount / durationInSeconds) * 60 : 0;

      // O simulare foarte simplificatÄƒ a pauzelor, bazatÄƒ pe punctuaÈ›ie
      const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0);
      const averageSentenceLength = sentences.length > 0 ? wordCount / sentences.length : 0;

      let breathingFeedback = '';
      if (wpm > 180) { // Prag arbitrar pentru ritm rapid
        breathingFeedback = 'Ai vorbit Ã®ntr-un ritm rapid azi.';
      } else if (wpm < 80 && wpm > 0) { // Prag arbitrar pentru ritm lent
        breathingFeedback = 'Ai un ritm de vorbire calm.';
      }

      if (sentences.length > 1 && averageSentenceLength < 5) { // PropoziÈ›ii scurte pot indica pauze frecvente sau agitaÈ›ie
         breathingFeedback += ' Pauzele scurte pot semnala agitaÈ›ie.';
      } else if (sentences.length > 1 && averageSentenceLength > 15) { // PropoziÈ›ii lungi pot indica un flux coerent
         breathingFeedback += ' Fluxul coerent al vorbirii.';
      }

      return { wpm: wpm.toFixed(0), breathingFeedback };
    }


    // FuncÈ›ia pentru a Ã®ncepe Ã®nregistrarea
    function startRecording() {
      if (!('webkitSpeechRecognition' in window)) {
        recordingStatus.textContent = 'API-ul de recunoaÈ™tere vocalÄƒ nu este suportat de browserul tÄƒu.';
        return;
      }

      recognition = new webkitSpeechRecognition();
      recognition.continuous = true; // ContinuÄƒ sÄƒ asculte
      recognition.interimResults = true; // AfiÈ™eazÄƒ rezultate provizorii
      recognition.lang = 'ro-RO'; // SeteazÄƒ limba la romÃ¢nÄƒ

      let finalTranscript = ''; // StocheazÄƒ transcrierea finalÄƒ pentru sesiune

      recognition.onstart = () => {
        isRecording = true;
        startTime = Date.now();
        recordingStatus.textContent = 'ğŸ™ï¸ Ascult...';
        transcriptArea.innerHTML = '<p class="text-gray-500 text-center italic">VorbeÈ™te liber. LumiYE te ascultÄƒ...</p>'; // CurÄƒÈ›Äƒ la Ã®nceput
        currentTranscript = ''; // ReseteazÄƒ transcrierea la Ã®nceputul unei noi sesiuni

        // ActualizeazÄƒ bara de progres la fiecare secundÄƒ
        recordingInterval = setInterval(() => {
          const elapsed = (Date.now() - startTime) / 1000;
          const progress = (elapsed / maxRecordingTime) * 100;
          progressBar.style.width = `${Math.min(progress, 100)}%`;

          if (elapsed >= maxRecordingTime) {
            stopRecording(); // OpreÈ™te Ã®nregistrarea dupÄƒ timpul maxim
          }
        }, 1000);
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript + '. '; // AdaugÄƒ un punct la finalul propoziÈ›iei
            // AdaugÄƒ propoziÈ›ia finalÄƒ Ã®n zona de transcriere cu animaÈ›ie
            const p = document.createElement('p');
            p.textContent = event.results[i][0].transcript;
            p.classList.add('sentence-pop-in');
            transcriptArea.appendChild(p);
            transcriptArea.scrollTop = transcriptArea.scrollHeight; // ScrolleazÄƒ automat
            currentTranscript = finalTranscript; // ActualizeazÄƒ transcrierea curentÄƒ
            sentenceCount++;

          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        // PoÈ›i afiÈ™a interimTranscript separat dacÄƒ vrei feedback instant, dar pentru simplitate, ne concentrÄƒm pe finalTranscript
      };

      recognition.onerror = (event) => {
        console.error('Eroare recunoaÈ™tere vocalÄƒ:', event.error);
        recordingStatus.textContent = `Eroare: ${event.error}. Te rugÄƒm sÄƒ Ã®ncerci din nou.`;
        isRecording = false;
        clearInterval(recordingInterval);
      };

      recognition.onend = () => {
        if (isRecording) { // Doar dacÄƒ nu a fost opritÄƒ manual
          isRecording = false;
          clearInterval(recordingInterval);
          recordingStatus.textContent = 'Ãnregistrare Ã®ncheiatÄƒ. AnalizÄƒm...';
          processSession(finalTranscript); // ProceseazÄƒ sesiunea la final
        }
      };

      recognition.start();
    }

    // FuncÈ›ia pentru a opri Ã®nregistrarea
    function stopRecording() {
      if (isRecording) {
        recognition.stop();
        isRecording = false;
        clearInterval(recordingInterval);
        recordingStatus.textContent = 'Ãnregistrare Ã®ncheiatÄƒ. AnalizÄƒm...';
        processSession(currentTranscript); // ProceseazÄƒ sesiunea
      }
    }

    // FuncÈ›ia principalÄƒ de procesare a sesiunii
    function processSession(transcript) {
      const duration = (Date.now() - startTime) / 1000; // Durata sesiunii Ã®n secunde
      const { positives, negatives, intentii } = analyzeText(transcript);
      const { wpm, breathingFeedback } = analyzeBreathing(transcript, duration);

      const sessionData = {
        time: new Date().toLocaleString('ro-RO', { dateStyle: 'medium', timeStyle: 'short' }),
        transcript: transcript,
        duration: duration.toFixed(0), // Durata Ã®n secunde
        analysis: {
          positives: positives,
          negatives: negatives,
          highWords: [], // Acestea vor fi populate mai tÃ¢rziu cu cuvinte cheie reale
          lowWords: [], // Acestea vor fi populate mai tÃ¢rziu cu cuvinte cheie reale
          intentii: intentii,
          wpm: wpm,
          breathingFeedback: breathingFeedback
        }
      };

      // SalvÄƒm datele sesiunii Ã®n localStorage pentru a fi accesibile Ã®n reports.html
      // Aici nu mai salvÄƒm direct, ci trimitem la pagina de feedback
      localStorage.setItem('current_session_data', JSON.stringify(sessionData));

      // RedirecÈ›ionÄƒm cÄƒtre pagina de feedback
      window.location.href = 'feedback.html';
    }

    // AscultÄƒ evenimentul de click pe butonul de microfon
    microphoneButton.addEventListener('click', () => {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    });

    // La Ã®ncÄƒrcarea paginii, dacÄƒ venim de la home, pornim automat Ã®nregistrarea
    window.onload = () => {
      // VerificÄƒm dacÄƒ am venit de pe pagina principalÄƒ (simulare)
      // Ãn aplicaÈ›ia realÄƒ, ai putea folosi un parametru URL sau sessionStorage
      const referrer = document.referrer;
      if (referrer.includes('index.html')) {
        startRecording();
      }
    };
  </script>
</body>
</html>

