<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forma - My Forms</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js"></script>
    <script src="common.js"></script>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title-left">My Forms</h1> <input type="text" id="searchFormsInput" class="search-input" placeholder="Search forms...">
            <button id="accountSettingsButton" class="icon-button">
                <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.33 0-4 .67-4 2v3h8v-3c0-1.33-2.67-2-4-2z"/></svg>
            </button>
        </header>

        <div class="glass-container">
            <h2 class="section-title">Today's Tasks/Objectives</h2>
            <div id="todayTasksList" class="list-container custom-scrollbar">
                <p id="noTodayTasksMessage" class="empty-state-message">No tasks scheduled for today.</p>
            </div>
        </div>

        <div class="glass-container">
            <h2 class="section-title">All Forms</h2>
            <div id="formsList" class="list-container custom-scrollbar">
                <p class="empty-state-message" id="noFormsMessage">No forms created yet.</p>
            </div>
        </div>

        <nav class="main-navbar">
            <button id="navbarMicButton" class="navbar-mic-button">
                <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="navbarMicIcon"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 4c0-1.66-1.34-3-3-3S9 2.34 9 4v7c0 1.66 1.34 3 3 3zm5.3-3c0 3.53-2.64 6.43-6.14 6.95V21h-2v-3.05c-3.5-.52-6.16-3.42-6.16-6.95H2c0 4.17 3.13 7.63 7.27 8.24v3.01h5.46v-3.01c4.14-.61 7.27-4.07 7.27-8.24h-1.7z"/></svg>
            </button>
            <div class="navbar-group">
                <a href="index.html" class="navbar-button">
                    <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display: none;"></svg>
                    <span>New Form</span>
                </a>
                <a href="my-forms.html" class="navbar-button active">
                    <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display: none;"></svg>
                    <span>My Forms</span>
                </a>
            </div>
            <button id="navbarAiButton" class="navbar-ai-button" onclick="alert('AI Chat functionality to be implemented.')">
                <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 10v-.5c0-.28-.22-.5-.5-.5h-1c-.28 0-.5.22-.5.5V10h-1v-.5c0-.28-.22-.5-.5-.5h-1c-.28 0-.5.22-.5.5V10H2.5c-.28 0-.5.22-.5.5V11c0 .28.22.5.5.5H5v-.5c0-.28.22-.5.5-.5h1c.28 0 .5.22.5.5V11h1v-.5c0-.28.22-.5.5-.5h1c.28 0 .5.22.5.5V11h2.5c.28 0 .5-.22.5-.5V10.5c0-.28-.22-.5-.5-.5H16.5V9.5c0-.28-.22-.5-.5-.5h-1c-.28 0-.5.22-.5.5V10h-1V9.5c0-.28-.22-.5-.5-.5h-1c-.28 0-.5.22-.5.5V10H9v-.5zM12 20c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm-.88-10.95L9.65 9.12l.23-.23c.09-.09.2-.14.32-.14.12 0 .23.05.32.14l.23.23c.09.09.14.2.14.32 0 .12-.05.23-.14.32L9.9 10.95c-.09.09-.2.14-.32.14s-.23-.05-.32-.14L9.07 10.08c-.09-.09-.14-.2-.14-.32 0-.12.05-.23.14-.32zM12.95 10.08l-.23-.23c-.09-.09-.2-.14-.32-.14s-.23.05-.32.14L11.8 10.95c-.09.09-.14.2-.14.32s.05.23.14.32l.23.23c.09.09.2.14.32.14s.23-.05.32-.14l.23-.23c.09-.09.14-.2.14-.32s-.05-.23-.14-.32z"/></svg>
            </button>
        </nav>

    </div>

    <script>
        // DOM Elements
        const formsListContainer = document.getElementById('formsList');
        const noFormsMessage = document.getElementById('noFormsMessage');
        const todayTasksList = document.getElementById('todayTasksList');
        const noTodayTasksMessage = document.getElementById('noTodayTasksMessage');
        const searchFormsInput = document.getElementById('searchFormsInput');
        const accountSettingsButton = document.getElementById('accountSettingsButton');

        // Navbar buttons (needed for active state handling, even if no direct JS function for them here)
        const navbarMicButton = document.getElementById('navbarMicButton');
        const navbarAiButton = document.getElementById('navbarAiButton');

        // --- Render Functions ---

        async function renderFormsList(searchQuery = '') {
            const allForms = (await db.get('formsMetadata')) || []; 
            let filteredForms = allForms;

            if (searchQuery) {
                const lowerCaseQuery = searchQuery.toLowerCase();
                filteredForms = allForms.filter(form => 
                    (form.title && form.title.toLowerCase().includes(lowerCaseQuery)) ||
                    (form.beneficiary && form.beneficiary.toLowerCase().includes(lowerCaseQuery)) ||
                    (form.address && form.address.toLowerCase().includes(lowerCaseQuery)) ||
                    (form.initialNotes && form.initialNotes.toLowerCase().includes(lowerCaseQuery)) ||
                    (form.formNumber && String(form.formNumber).includes(lowerCaseQuery))
                    // Add more fields here as needed for search
                );
            }

            formsListContainer.innerHTML = ''; 

            if (filteredForms.length === 0) {
                noFormsMessage.style.display = 'block';
                return;
            } else {
                noFormsMessage.style.display = 'none';
            }

            // Sort forms by last modified date, newest first
            filteredForms.sort((a, b) => new Date(b.lastModified).getTime() - new Date(a.lastModified).getTime());

            for (const form of filteredForms) { 
                let statusColorClass = 'status-gray-bar'; 
                let statusTextClass = 'text-status-gray';
                let statusText = 'Not Started';

                if (form.status === 'in-progress') {
                    statusColorClass = 'status-yellow-bar'; // Using yellow for in-progress
                    statusTextClass = 'text-status-yellow';
                    statusText = 'In Progress';
                } else if (form.status === 'completed') {
                    statusColorClass = 'status-green-bar'; // Using green for completed
                    statusTextClass = 'text-status-green';
                    statusText = 'Completed';
                }

                // Count dictated notes and tasks for display
                const formRecordings = (await db.get(`formRecordings-${form.id}`)) || [];
                const numNotes = formRecordings.length;
                const numTasks = formRecordings.reduce((total, rec) => total + (rec.tasks ? rec.tasks.length : 0), 0);

                const card = document.createElement('div');
                card.className = 'card-item';
                card.innerHTML = `
                    <div class="status-indicator-bar ${statusColorClass}"></div>
                    <h3 class="card-item-title">Form #${form.formNumber || 'N/A'} - ${form.title || 'Untitled Form'}</h3>
                    <p class="card-item-meta">
                        ${new Date(form.createdAt).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} • 
                        ${form.beneficiary || 'No Client'} • 
                        ${form.type || 'General'}
                    </p>
                    <p class="card-item-text">
                        <span class="${statusTextClass}">${statusText}</span> • 
                        ${numNotes} Note(s) • ${numTasks} Task(s)
                    </p>
                    <div class="card-item-actions">
                        <button onclick="viewForm('${form.id}')" class="button-primary small-button">View/Edit</button>
                        <button onclick="deleteForm('${form.id}')" class="button-danger small-button">Delete</button>
                    </div>
                `;
                formsListContainer.appendChild(card);
            }
        }

        async function renderTodayTasks() {
            const allForms = (await db.get('formsMetadata')) || [];
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            const tasksForToday = allForms.filter(form => {
                if (!form.plannedDateTime) return false;
                const formPlannedDate = new Date(form.plannedDateTime);
                formPlannedDate.setHours(0, 0, 0, 0);
                return formPlannedDate.getTime() === today.getTime() && form.status !== 'completed';
            });

            todayTasksList.innerHTML = '';
            if (tasksForToday.length === 0) {
                noTodayTasksMessage.style.display = 'block';
            } else {
                noTodayTasksMessage.style.display = 'none';
                tasksForToday.forEach(form => {
                    let statusTextClass = 'text-status-yellow'; // For in progress/not started
                    if (form.status === 'completed') statusTextClass = 'text-status-green';
                    if (form.status === 'not-started') statusTextClass = 'text-status-gray';

                    const taskElement = document.createElement('div');
                    taskElement.className = 'card-item'; // Re-use card-item style for consistency
                    taskElement.style.paddingLeft = '0.75rem'; // Remove status bar for tasks here
                    taskElement.style.paddingRight = '0.75rem';
                    taskElement.onclick = () => { window.location.href = `index.html?id=${form.id}`; }; // Link to Home page to continue dictation
                    taskElement.innerHTML = `
                        <h3 class="card-item-title" style="padding-left:0;">Form #${form.formNumber || 'N/A'} - ${form.title || 'Untitled Form'}</h3>
                        <p class="card-item-meta" style="padding-left:0;">
                            ${form.beneficiary || 'No Client'} • ${form.type || 'General'} • <span class="${statusTextClass}">${form.status.charAt(0).toUpperCase() + form.status.slice(1)}</span>
                        </p>
                    `;
                    todayTasksList.appendChild(taskElement);
                });
            }
        }

        // --- Form Actions ---

        function viewForm(id) {
            // "View/Edit" button on card leads to form-report.html for detailed view and editing
            window.location.href = `form-report.html?id=${id}`; 
        }

        async function deleteForm(id) {
            if (!confirm('Are you sure you want to delete this form and all its associated dictated notes and tasks? This cannot be undone.')) return;

            let allForms = (await db.get('formsMetadata')) || [];
            allForms = allForms.filter(f => f.id !== id);
            await db.set('formsMetadata', allForms);

            await db.del(`formRecordings-${id}`); 
            
            alert('Form and all associated notes/tasks deleted.');
            renderFormsList(); 
            renderTodayTasks(); 
        }

        // --- Event Listeners ---

        // Search functionality with debounce
        searchFormsInput.addEventListener('input', debounce(() => {
            renderFormsList(searchFormsInput.value);
        }, 300)); // 300ms debounce

        accountSettingsButton.addEventListener('click', () => {
            alert('Account settings and preferences functionality to be implemented here.');
        });

        // --- Page Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            await renderFormsList();
            await renderTodayTasks();
        });
    </script>
</body>
</html>