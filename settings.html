<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Setări – AudioForm</title>

  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#1e40af" />

  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <script src="https://cdn.tailwindcss.com"></script>

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-gray-50 text-gray-800 antialiased min-h-screen flex flex-col
             dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  
  <header class="p-4 bg-white shadow-md dark:bg-gray-800 sticky top-0 z-40">
    <a href="dashboard.html" class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors duration-200" aria-label="Înapoi la Dashboard">
      <i class="fas fa-arrow-left mr-2"></i>
      <h1 class="text-lg font-semibold text-center text-gray-900 dark:text-gray-50 flex-grow">Setările Mele</h1>
    </a>
  </header>

  <main class="flex-grow max-w-3xl mx-auto p-6 space-y-8">
    <div id="plugin-slot-settings-top" class="w-full">
      </div>

    <div id="feedback-message" data-testid="feedback-message-display" class="mt-4 text-sm text-center hidden p-3 rounded-lg"></div>

    <section class="bg-white dark:bg-gray-800 rounded-lg shadow p-6" data-testid="general-preferences-section">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Preferințe Generale</h2>

      <div class="mb-5">
        <label for="language-select" class="block font-medium text-gray-700 dark:text-gray-200 mb-2">Limba interfeței</label>
        <select id="language-select" data-testid="language-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500
               dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
          <option value="ro">Română (RO)</option>
          <option value="en">English (EN)</option>
          </select>
      </div>

      <div class="mb-5 flex items-center justify-between py-2">
        <label for="dark-mode-toggle" class="font-medium text-gray-700 dark:text-gray-200 cursor-pointer flex-grow">
          Activează modul întunecat
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Ajustează tema aplicației pentru confort vizual.</p>
        </label>
        <input type="checkbox" id="dark-mode-toggle" data-testid="dark-mode-toggle" class="form-checkbox h-6 w-6 text-blue-600 rounded-full focus:ring-blue-500 transition duration-150 ease-in-out
               dark:bg-gray-600 dark:border-gray-500 dark:checked:bg-blue-600"
               role="switch" aria-checked="false" aria-label="Comută modul întunecat">
      </div>

      <div class="mt-4 border border-gray-300 rounded-lg p-2 bg-white dark:bg-gray-800 shadow text-sm">
        <p class="text-gray-600 dark:text-gray-300">Așa va arăta aplicația în tema selectată.</p>
        <div class="flex items-center gap-2 mt-2">
          <div class="w-4 h-4 rounded-full bg-blue-500"></div>
          <div class="w-16 h-2 bg-gray-300 rounded"></div>
          <div class="w-8 h-2 bg-gray-300 rounded"></div>
        </div>
      </div>


      <div class="mb-5 flex items-center justify-between py-2">
        <label for="notifications-toggle" class="font-medium text-gray-700 dark:text-gray-200 cursor-pointer flex-grow">
          Primește notificări despre finalizarea rapoartelor
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Primește alerte direct pe dispozitivul tău.</p>
        </label>
        <input type="checkbox" id="notifications-toggle" data-testid="notifications-toggle" class="form-checkbox h-6 w-6 text-blue-600 rounded-full focus:ring-blue-500 transition duration-150 ease-in-out
               dark:bg-gray-600 dark:border-gray-500 dark:checked:bg-blue-600"
               role="switch" aria-checked="false" aria-label="Comută notificările pentru rapoarte">
      </div>

      <div class="mb-5 flex items-center justify-between py-2">
        <label for="autosave-toggle" class="font-medium text-gray-700 dark:text-gray-200 cursor-pointer flex-grow">
          Activează salvarea automată a rapoartelor
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Rapoartele se vor salva automat ca draft la fiecare 10 secunde de inactivitate în timpul editării.</p>
        </label>
        <input type="checkbox" id="autosave-toggle" data-testid="autosave-toggle" class="form-checkbox h-6 w-6 text-blue-600 rounded-full focus:ring-blue-500 transition duration-150 ease-in-out
               dark:bg-gray-600 dark:border-gray-500 dark:checked:bg-blue-600"
               role="switch" aria-checked="true" aria-label="Comută salvarea automată a rapoartelor">
      </div>
      
      </section>

    <section class="bg-white dark:bg-gray-800 rounded-lg shadow p-6" data-testid="account-settings-section">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Setări Cont</h2>
      
      <div class="mb-4">
        <p class="text-gray-700 dark:text-gray-200">Email: <span class="font-medium">mike@audioform.me</span></p>
        <p class="text-gray-700 dark:text-gray-200">Tip Abonament: <span class="font-medium">Premium</span></p>
      </div>

      <div class="flex flex-col sm:flex-row gap-3">
        <button id="change-password-btn" data-testid="change-password-button" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-200 ease-in-out flex items-center justify-center">
          <i class="fas fa-lock mr-2"></i> Schimbă parola
        </button>
        <button id="manage-subscription-btn" data-testid="manage-subscription-button" class="bg-green-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-200 ease-in-out flex items-center justify-center">
          <i class="fas fa-credit-card mr-2"></i> Gestionează abonamentul
        </button>
      </div>
      <button id="delete-account-btn" data-testid="delete-account-button" class="mt-4 bg-red-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-red-700 transition duration-200 ease-in-out flex items-center justify-center">
          <i class="fas fa-user-times mr-2"></i> Șterge cont
      </button>

      <div class="mt-6 p-3 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg text-sm text-blue-700 dark:text-blue-300">
        <p><i class="fas fa-cloud-upload-alt mr-2"></i> Preferințele sunt salvate local. În curând, vor putea fi sincronizate cu contul tău online.</p>
      </div>
    </section>

    <section class="bg-white dark:bg-gray-800 rounded-lg shadow p-6" data-testid="template-management-section">
      <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Gestionare Șabloane</h2>
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Personalizează sau adaugă noi șabloane pentru rapoartele tale.</p>
      
      <div class="flex flex-col sm:flex-row gap-3">
        <a href="templates.html" data-testid="add-custom-template-link" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-200 ease-in-out flex items-center justify-center">
          <i class="fas fa-plus mr-2"></i> Adaugă/Editează șabloane
        </a>
        <button id="import-templates-btn" data-testid="import-templates-button" class="bg-gray-500 text-white px-5 py-2 rounded-lg shadow-md hover:bg-gray-600 transition duration-200 ease-in-out flex items-center justify-center disabled:opacity-50" disabled>
          <i class="fas fa-file-import mr-2"></i> Importă șabloane
        </button>
      </div>

      <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-100">Backup & Restaurare Șabloane</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Salvează șabloanele tale local sau încarcă-le pentru backup.</p>
        <div class="flex flex-col sm:flex-row gap-3">
          <button id="export-templates-btn" data-testid="export-templates-button" class="bg-purple-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-purple-700 transition duration-200 ease-in-out flex items-center justify-center">
            <i class="fas fa-file-export mr-2"></i> Exportă șabloane (.json)
          </button>
          <button id="import-templates-json-btn" data-testid="import-templates-json-button" class="bg-orange-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-orange-700 transition duration-200 ease-in-out flex items-center justify-center">
            <i class="fas fa-file-import mr-2"></i> Importă din .json
            <input type="file" id="import-templates-file-input" class="hidden" accept=".json">
          </button>
        </div>
      </div>
    </section>

    <div id="plugin-slot-settings-bottom" class="w-full mt-6">
      <div id="debug-info-section" class="hidden mt-8 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg shadow text-left text-sm font-mono dark:text-gray-300">
        <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-100">🧪 Debug Info (Preferințe Locale)</h3>
        <pre id="prefs-debug-output"></pre>
      </div>
    </div>
  </main>

  <footer class="text-center text-sm text-gray-500 dark:text-gray-400 mt-8 p-4">
    Ai întrebări? <a href="help.html" class="underline text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors duration-150" data-testid="help-link">Găsește răspunsuri aici</a> sau contactează <a href="mailto:suport@audioform.me" class="underline text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 transition-colors duration-150" data-testid="support-email">suportul</a>.
  </footer>


  <script>
    // Determine if debug mode is active globally
    const isDebugMode = location.search.includes('debug=true');

    // Helper for secure logging
    const secureLog = (message, ...args) => {
      if (isDebugMode) {
        console.log(`[DEBUG] ${message}`, ...args);
      }
    };

    // Show/Hide Feedback Message - Centralized utility function
    const feedbackMessageEl = document.getElementById('feedback-message');
    function showFeedback(message, type = 'success') {
        feedbackMessageEl.textContent = message;
        feedbackMessageEl.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-yellow-600', 'text-blue-600',
                                            'bg-green-50', 'bg-red-50', 'bg-yellow-50', 'bg-blue-50',
                                            'border-green-200', 'border-red-200', 'border-yellow-200', 'border-blue-200',
                                            'dark:text-green-400', 'dark:text-red-400', 'dark:text-yellow-400', 'dark:text-blue-400',
                                            'dark:bg-green-900', 'dark:bg-red-900', 'dark:bg-yellow-900', 'dark:bg-blue-900',
                                            'dark:border-green-700', 'dark:border-red-700', 'dark:border-yellow-700', 'dark:border-blue-700');
        if (type === 'success') {
            feedbackMessageEl.classList.add('text-green-600', 'bg-green-50', 'border-green-200', 'dark:text-green-400', 'dark:bg-green-900', 'dark:border-green-700');
        } else if (type === 'error') {
            feedbackMessageEl.classList.add('text-red-600', 'bg-red-50', 'border-red-200', 'dark:text-red-400', 'dark:bg-red-900', 'dark:border-red-700');
        } else if (type === 'warning') {
            feedbackMessageEl.classList.add('text-yellow-600', 'bg-yellow-50', 'border-yellow-200', 'dark:text-yellow-400', 'dark:bg-yellow-900', 'dark:border-yellow-700');
        } else if (type === 'info') {
            feedbackMessageEl.classList.add('text-blue-600', 'bg-blue-50', 'border-blue-200', 'dark:text-blue-400', 'dark:bg-blue-900', 'dark:border-blue-700');
        }
        feedbackMessageEl.classList.remove('hidden');
        // Hide after 5 seconds
        setTimeout(() => {
            feedbackMessageEl.classList.add('hidden');
        }, 5000);
    }


    document.addEventListener('DOMContentLoaded', () => {
      // === PWA - Register Service Worker (shared from other pages) ===
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => secureLog('PWA ServiceWorker registered:', registration))
            .catch(error => console.error('PWA ServiceWorker registration failed:', error)); 
        });
      }

      // === DOM Elements ===
      const darkToggle = document.getElementById('dark-mode-toggle');
      const notificationsToggle = document.getElementById('notifications-toggle');
      const languageSelect = document.getElementById('language-select');
      const autosaveToggle = document.getElementById('autosave-toggle'); // New autosave toggle
      const changePasswordBtn = document.getElementById('change-password-btn');
      const manageSubscriptionBtn = document.getElementById('manage-subscription-btn');
      const deleteAccountBtn = document.getElementById('delete-account-btn');
      const importTemplatesBtn = document.getElementById('import-templates-btn'); // Existing disabled button
      const exportTemplatesBtn = document.getElementById('export-templates-btn'); // New export button
      const importTemplatesJsonBtn = document.getElementById('import-templates-json-btn'); // New import JSON button
      const importTemplatesFileInput = document.getElementById('import-templates-file-input'); // Hidden file input
      const prefsDebugOutput = document.getElementById('prefs-debug-output'); // Debug info output
      const debugInfoSection = document.getElementById('debug-info-section'); // Debug info section wrapper


      // === Initial Load Preferences ===
      // Dark Mode: Load user preference, if none, use system preference
      const savedDarkModePref = localStorage.getItem('pref_darkmode');
      if (savedDarkModePref !== null) { // User has a saved preference
        darkToggle.checked = savedDarkModePref === 'true';
      } else { // No saved preference, use system preference
        darkToggle.checked = window.matchMedia('(prefers-color-scheme: dark)').matches;
      }
      // Apply initial dark mode based on checked state
      document.documentElement.classList.toggle('dark', darkToggle.checked);
      darkToggle.setAttribute('aria-checked', darkToggle.checked); // Set initial aria-checked

      notificationsToggle.checked = localStorage.getItem('pref_notifications') === 'true';
      notificationsToggle.setAttribute('aria-checked', notificationsToggle.checked); // Set initial aria-checked

      languageSelect.value = localStorage.getItem('pref_language') || 'ro'; // Default to 'ro'

      // [4] Auto-Save Toggle: Load preference
      autosaveToggle.checked = localStorage.getItem('pref_autosave') === 'true'; // Default is now 'true' based on this line
      if (localStorage.getItem('pref_autosave') === null) { // If not set, default to true
        autosaveToggle.checked = true;
        localStorage.setItem('pref_autosave', 'true');
      }
      autosaveToggle.setAttribute('aria-checked', autosaveToggle.checked);


      // === Event Listeners for Preferences ===
      darkToggle.addEventListener('change', () => {
        const isDarkModeEnabled = darkToggle.checked;
        localStorage.setItem('pref_darkmode', isDarkModeEnabled);
        document.documentElement.classList.toggle('dark', isDarkModeEnabled);
        darkToggle.setAttribute('aria-checked', isDarkModeEnabled); // Update aria-checked
        showFeedback(`Modul întunecat ${isDarkModeEnabled ? 'activat' : 'dezactivat'}.`, 'info');
        secureLog(`Dark mode toggled: ${isDarkModeEnabled}`);
      });

      notificationsToggle.addEventListener('change', () => {
        const areNotificationsEnabled = notificationsToggle.checked;
        localStorage.setItem('pref_notifications', areNotificationsEnabled);
        notificationsToggle.setAttribute('aria-checked', areNotificationsEnabled); // Update aria-checked
        // In a real app, this would trigger browser notification permission requests/revocations
        showFeedback(`Notificările sunt ${areNotificationsEnabled ? 'activate' : 'dezactivate'}.`, 'info');
        secureLog(`Notifications toggled: ${areNotificationsEnabled}`);
      });

      languageSelect.addEventListener('change', () => {
        const selectedLanguage = languageSelect.value;
        localStorage.setItem('pref_language', selectedLanguage);
        showFeedback(`Limba a fost setată la ${selectedLanguage.toUpperCase()}.`, 'success');
        secureLog(`Language changed to: ${selectedLanguage}`);
        // TODO: Implement actual internationalization (i18n) to change UI text dynamically
      });

      // [4] Auto-Save Toggle Listener
      autosaveToggle.addEventListener('change', () => {
        const isAutosaveEnabled = autosaveToggle.checked;
        localStorage.setItem('pref_autosave', isAutosaveEnabled);
        autosaveToggle.setAttribute('aria-checked', isAutosaveEnabled);
        showFeedback(`Salvarea automată este acum ${isAutosaveEnabled ? 'activată' : 'dezactivată'}.`, 'info');
        secureLog(`Autosave toggled: ${isAutosaveEnabled}`);
      });


      // === Account Settings Actions (Simulated) ===
      changePasswordBtn.addEventListener('click', () => {
        showFeedback('Funcționalitate de schimbare parolă în dezvoltare.', 'info');
        secureLog('Change password button clicked.');
        // TODO: Redirect to a password change page/modal
      });

      manageSubscriptionBtn.addEventListener('click', () => {
        showFeedback('Funcționalitate de gestionare abonament în dezvoltare.', 'info');
        secureLog('Manage subscription button clicked.');
        // TODO: Redirect to billing portal (external or internal)
      });

      deleteAccountBtn.addEventListener('click', () => {
        if (confirm('Ești sigur că vrei să ștergi contul? Această acțiune este ireversibilă.')) {
          showFeedback('Funcționalitate de ștergere cont în dezvoltare.', 'warning');
          secureLog('Delete account confirmed.');
          // TODO: Call backend API to delete account, then clear local storage and redirect to login/home
        } else {
          showFeedback('Ștergerea contului a fost anulată.', 'info');
          secureLog('Delete account cancelled.');
        }
      });

      // === Template Management Actions ===
      // The 'Add/Edit Templates' button is an <a> tag pointing to templates.html
      importTemplatesBtn.addEventListener('click', () => {
        showFeedback('Funcționalitate de import șabloane în dezvoltare.', 'info');
        secureLog('Import templates button clicked (disabled for now).');
        // TODO: Implement file upload or API call for template import (maybe use the JSON import below instead)
      });

      // [2] Export/Import Preferințe (.json local) - For Templates (and general prefs)
      exportTemplatesBtn.addEventListener('click', () => {
        // Collect all templates and possibly general preferences
        const templatesToExport = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('audioFormTemplate_') || key.startsWith('audioFormDraft_') || key.startsWith('audioFormFinalized_')) {
                try {
                    templatesToExport.push({ key: key, data: JSON.parse(localStorage.getItem(key)) });
                } catch (e) {
                    secureLog(`Error parsing template/report for export: ${key}`, e);
                }
            }
        }
        
        // Also export general preferences
        const generalPrefs = {
          pref_darkmode: localStorage.getItem('pref_darkmode'),
          pref_notifications: localStorage.getItem('pref_notifications'),
          pref_language: localStorage.getItem('pref_language'),
          pref_autosave: localStorage.getItem('pref_autosave'),
        };

        const exportData = {
          version: "1.0",
          timestamp: new Date().toISOString(),
          preferences: generalPrefs,
          templatesAndReports: templatesToExport
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `audioform_backup_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showFeedback('Datele de backup au fost exportate!', 'success');
        secureLog('Exported preferences and templates.');
      });

      importTemplatesJsonBtn.addEventListener('click', () => {
        importTemplatesFileInput.click(); // Trigger the hidden file input click
      });

      importTemplatesFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedData = JSON.parse(e.target.result);
            secureLog('Imported data:', importedData);

            if (importedData.version === "1.0" && importedData.preferences && importedData.templatesAndReports) {
                // Restore General Preferences
                for (const prefKey in importedData.preferences) {
                    if (importedData.preferences.hasOwnProperty(prefKey)) {
                        localStorage.setItem(prefKey, importedData.preferences[prefKey]);
                    }
                }
                // Restore Templates and Reports
                importedData.templatesAndReports.forEach(item => {
                    localStorage.setItem(item.key, JSON.stringify(item.data));
                });
                
                showFeedback('Datele au fost importate cu succes! Reîmprospătează pagina.', 'success');
                secureLog('Successfully imported data.');
                // Prompt user to refresh to see changes applied immediately
                if (confirm('Importul a fost finalizat. Reîmprospătați pagina acum pentru a aplica modificările?')) {
                    location.reload();
                }
            } else {
                showFeedback('Fișierul selectat nu este un fișier de backup AudioForm valid.', 'error');
                secureLog('Invalid import file format.');
            }
          } catch (error) {
            console.error('Error parsing imported JSON:', error); // Always log critical errors
            showFeedback('Eroare la citirea fișierului JSON. Asigură-te că este valid.', 'error');
          } finally {
            importTemplatesFileInput.value = ''; // Clear file input
          }
        };
        reader.readAsText(file);
      });


      // === Plugin slot handlers ===
      const pluginSlotSettingsTop = document.getElementById('plugin-slot-settings-top');
      const pluginSlotSettingsBottom = document.getElementById('plugin-slot-settings-bottom');

      if (window.AudioFormPlugin) {
        if (typeof window.AudioFormPlugin.renderSettingsTop === 'function') {
          pluginSlotSettingsTop.appendChild(window.AudioFormPlugin.renderSettingsTop());
          secureLog('Plugin rendered in settings top slot.');
        }
        if (typeof window.AudioFormPlugin.renderSettingsBottom === 'function') {
          pluginSlotSettingsBottom.appendChild(window.AudioFormPlugin.renderSettingsBottom());
          secureLog('Plugin rendered in settings bottom slot.');
        }
      }
      
      // === Debug Mode Integration ===
      if (isDebugMode) {
        console.log('🧪 DEBUG MODE ACTIVAT pentru Settings Page');
        debugInfoSection.classList.remove('hidden'); // Show debug info section

        // Function to update debug info display
        const updateDebugInfo = () => {
          const prefs = {
            darkmode: localStorage.getItem('pref_darkmode'),
            notifications: localStorage.getItem('pref_notifications'),
            language: localStorage.getItem('pref_language'),
            autosave: localStorage.getItem('pref_autosave'),
          };
          prefsDebugOutput.textContent = JSON.stringify(prefs, null, 2);
        };
        
        // Initial display
        updateDebugInfo();
        // Update on preference changes
        darkToggle.addEventListener('change', updateDebugInfo);
        notificationsToggle.addEventListener('change', updateDebugInfo);
        languageSelect.addEventListener('change', updateDebugInfo);
        autosaveToggle.addEventListener('change', updateDebugInfo);
      }
    });
  </script>
</body>
</html>