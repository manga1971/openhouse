<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Șabloane – AudioForm</title>

  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#1e40af" />

  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <script src="https://cdn.tailwindcss.com"></script>

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-gray-50 text-gray-800 antialiased min-h-screen flex flex-col
             dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">
  
  <header class="p-4 bg-white shadow-md dark:bg-gray-800 sticky top-0 z-40">
    <a href="settings.html" class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors duration-200" aria-label="Înapoi la Setări">
      <i class="fas fa-arrow-left mr-2"></i>
      <h1 class="text-lg font-semibold text-center text-gray-900 dark:text-gray-50 flex-grow">Gestionare Șabloane</h1>
    </a>
  </header>

  <main class="flex-grow max-w-3xl mx-auto p-6 space-y-6">
    <div id="plugin-slot-templates-top" class="w-full">
      </div>

    <div id="feedback-message" data-testid="feedback-message-display" class="mt-4 text-sm text-center hidden p-3 rounded-lg"></div>

    <div class="flex justify-between items-center" data-testid="template-controls">
      <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Șabloanele Mele</h2>
      <button id="add-template-btn" data-testid="add-template-button" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-200 ease-in-out transform hover:scale-105"
              aria-label="Adaugă un șablon nou">
        <i class="fas fa-plus mr-2"></i> Adaugă Șablon Nou
      </button>
    </div>

    <div id="template-list" data-testid="template-list" class="space-y-4">
      </div>

    <div id="no-templates" data-testid="no-templates-message" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center text-gray-600 dark:text-gray-300">
      <i class="fas fa-layer-group text-4xl mb-3"></i>
      <p class="text-lg font-semibold">Nu ai creat încă niciun șablon personalizat.</p>
      <p class="mt-2 text-sm">Începe prin a adăuga primul tău șablon!</p>
    </div>

    <div id="plugin-slot-templates-bottom" class="w-full mt-6">
      </div>
  </main>

  <script>
    // Determine if debug mode is active globally
    const isDebugMode = location.search.includes('debug=true');

    // Helper for secure logging
    const secureLog = (message, ...args) => {
      if (isDebugMode) {
        console.log(`[DEBUG] ${message}`, ...args);
      }
    };

    // [1] Show/Hide Feedback Message - Centralized utility function (reused from other pages)
    const feedbackMessageEl = document.getElementById('feedback-message');
    function showFeedback(message, type = 'success') {
        feedbackMessageEl.textContent = message;
        feedbackMessageEl.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-yellow-600', 'text-blue-600',
                                            'bg-green-50', 'bg-red-50', 'bg-yellow-50', 'bg-blue-50',
                                            'border-green-200', 'border-red-200', 'border-yellow-200', 'border-blue-200',
                                            'dark:text-green-400', 'dark:text-red-400', 'dark:text-yellow-400', 'dark:text-blue-400',
                                            'dark:bg-green-900', 'dark:bg-red-900', 'dark:bg-yellow-900', 'dark:bg-blue-900',
                                            'dark:border-green-700', 'dark:border-red-700', 'dark:border-yellow-700', 'dark:border-blue-700');
        if (type === 'success') {
            feedbackMessageEl.classList.add('text-green-600', 'bg-green-50', 'border-green-200', 'dark:text-green-400', 'dark:bg-green-900', 'dark:border-green-700');
        } else if (type === 'error') {
            feedbackMessageEl.classList.add('text-red-600', 'bg-red-50', 'border-red-200', 'dark:text-red-400', 'dark:bg-red-900', 'dark:border-red-700');
        } else if (type === 'warning') {
            feedbackMessageEl.classList.add('text-yellow-600', 'bg-yellow-50', 'border-yellow-200', 'dark:text-yellow-400', 'dark:bg-yellow-900', 'dark:border-yellow-700');
        } else if (type === 'info') {
            feedbackMessageEl.classList.add('text-blue-600', 'bg-blue-50', 'border-blue-200', 'dark:text-blue-400', 'dark:bg-blue-900', 'dark:border-blue-700');
        }
        feedbackMessageEl.classList.remove('hidden');
        // Hide after 5 seconds
        setTimeout(() => {
            feedbackMessageEl.classList.add('hidden');
        }, 5000);
    }


    document.addEventListener('DOMContentLoaded', () => {
      // [2] Dark Mode Autodetect + Coherent Toggling (reused from other pages)
      const applyDarkMode = () => {
        const darkPref = localStorage.getItem('pref_darkmode');
        // Apply dark mode based on saved preference, or system preference if no saved pref
        document.documentElement.classList.toggle('dark', darkPref === 'true' || (darkPref === null && window.matchMedia('(prefers-color-scheme: dark)').matches));
      };
      applyDarkMode();
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyDarkMode);


      // === PWA - Register Service Worker ===
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => secureLog('PWA ServiceWorker registered:', registration))
            .catch(error => console.error('PWA ServiceWorker registration failed:', error)); 
        });
      }

      // === DOM Elements ===
      const templateList = document.getElementById('template-list');
      const noTemplatesMessage = document.getElementById('no-templates');
      const addTemplateBtn = document.getElementById('add-template-btn');

      // === Template Management Functions ===
      function loadTemplates() {
        templateList.innerHTML = ''; // Clear existing list
        let customTemplateCount = 0;

        // [6] Sortare opțională după dată/nume (by lastModified)
        const localStorageKeys = Object.keys(localStorage).filter(key => key.startsWith('audioFormTemplate_'));
        localStorageKeys.sort((keyA, keyB) => {
            try {
                const templateA = JSON.parse(localStorage.getItem(keyA));
                const templateB = JSON.parse(localStorage.getItem(keyB));
                // Sort by lastModified in descending order (newest first)
                return (new Date(templateB.lastModified || 0).getTime()) - (new Date(templateA.lastModified || 0).getTime());
            } catch (e) {
                secureLog(`Error parsing template for sorting: ${keyA} or ${keyB}`, e);
                return 0; // Don't sort if parsing fails
            }
        });

        localStorageKeys.forEach(key => {
          try {
            const template = JSON.parse(localStorage.getItem(key));
            // Ensure template has a unique ID, if not, generate one (good practice for future editing)
            if (!template.id) {
                template.id = key; // Use the localStorage key as ID if not present
            }
            renderTemplateCard(template, key);
            customTemplateCount++;
          } catch (e) {
            console.warn(`[WARNING] Invalid template data in localStorage for key: ${key}`, e);
            secureLog(`Failed to parse template: ${key}`, e);
          }
        });

        noTemplatesMessage.classList.toggle('hidden', customTemplateCount > 0);
        secureLog(`Loaded ${customTemplateCount} custom templates.`);
      }

      function renderTemplateCard(template, localStorageKey) {
          const div = document.createElement('div');
          // [5] Animații și tranziții subtile
          div.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 transition duration-200 ease-in-out transform hover:-translate-y-1 hover:shadow-lg';
          div.setAttribute('data-template-id', template.id); // For easy identification in tests/debugging
          
          const fieldCount = template.fields ? template.fields.length : 0;
          const lastModified = template.lastModified ? new Date(template.lastModified).toLocaleString() : 'N/A';

          div.innerHTML = `
            <div class="flex-1 space-y-1">
              <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-100" data-testid="template-name-display">${template.name || 'Șablon fără nume'}</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                <i class="fas fa-list-alt mr-1"></i> ${fieldCount} câmpuri definite
              </p>
              <p class="text-xs text-gray-400 dark:text-gray-500">
                Ultima modificare: ${lastModified}
              </p>
            </div>
            <div class="flex gap-2 mt-3 sm:mt-0">
              <button class="action-btn text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" 
                      onclick="window.previewTemplate('${localStorageKey}')" aria-label="Previzualizează șablonul ${template.name || 'fără nume'}" data-testid="preview-template-button">
                <i class="fas fa-eye text-lg"></i><span class="sr-only">Previzualizează</span>
              </button>
              <button class="action-btn text-yellow-500 hover:text-yellow-600 dark:text-yellow-400 dark:hover:text-yellow-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" 
                      onclick="window.editTemplate('${localStorageKey}')" aria-label="Editează șablonul ${template.name || 'fără nume'}" data-testid="edit-template-button">
                <i class="fas fa-edit text-lg"></i><span class="sr-only">Editează</span>
              </button>
              <button class="action-btn text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" 
                      onclick="window.deleteTemplate('${localStorageKey}', '${template.name || 'fără nume'}')" aria-label="Șterge șablonul ${template.name || 'fără nume'}" data-testid="delete-template-button">
                <i class="fas fa-trash text-lg"></i><span class="sr-only">Șterge</span>
              </button>
            </div>
          `;
          templateList.appendChild(div);
      }

      // === Actions (Global Functions for onclick) ===
      window.editTemplate = (localStorageKey) => {
        secureLog(`Attempting to edit template with key: ${localStorageKey}`);
        const templateData = localStorage.getItem(localStorageKey);
        if (templateData) {
          sessionStorage.setItem('templateEditorData', templateData); // Store data for the editor page
          document.body.classList.add('opacity-0', 'transition-opacity', 'duration-500');
          setTimeout(() => {
            location.href = 'template-editor.html'; // Redirect to a dedicated editor page
          }, 300);
        } else {
          showFeedback('Șablonul nu a fost găsit. Poate a fost șters.', 'warning');
          secureLog(`Template not found for editing: ${localStorageKey}`);
        }
      };

      // [4] Previzualizare șablon
      window.previewTemplate = (localStorageKey) => {
        secureLog(`Attempting to preview template with key: ${localStorageKey}`);
        const templateData = localStorage.getItem(localStorageKey);
        if (templateData) {
          try {
            const parsedTemplate = JSON.parse(templateData);
            // Simulate how this template would look when starting a new recording
            // For simplicity, we'll direct to edit.html in readonly with a sample report
            sessionStorage.setItem('audioFormTempRecording', JSON.stringify({
                template: parsedTemplate, // Pass the actual template structure
                duration: 120, // Example duration
                transcription: `Acesta este un exemplu de transcriere simulată pentru previzualizarea șablonului "${parsedTemplate.name || 'fără nume'}". Aici ar apărea textul generat de AI, structurat conform câmpurilor definite în șablonul tău. De exemplu: "Vehiculul este un model recent. Clientul a menționat o problemă minoră. Recomandăm o verificare rapidă."`
                // In a real scenario, you'd generate a more complex sample based on template.fields
            }));
            document.body.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => {
              location.href = 'edit.html?readonly=true'; // View in edit mode for now
            }, 300);
          } catch (e) {
            console.error('Error parsing template for preview:', e);
            showFeedback('Eroare la previzualizarea șablonului. Datele sunt corupte.', 'error');
          }
        } else {
          showFeedback('Șablonul nu a fost găsit pentru previzualizare.', 'warning');
          secureLog(`Template not found for preview: ${localStorageKey}`);
        }
      };

      window.deleteTemplate = (localStorageKey, templateName) => {
        secureLog(`Attempting to delete template with key: ${localStorageKey} (${templateName})`);
        if (confirm(`Ești sigur că vrei să ștergi șablonul "${templateName}"? Această acțiune este ireversibilă.`)) {
          localStorage.removeItem(localStorageKey);
          loadTemplates(); // Reload and re-render the list
          showFeedback(`Șablonul "${templateName}" a fost șters.`, 'success');
          secureLog(`Template ${localStorageKey} deleted.`);
        }
      };

      // === Event Listeners ===
      addTemplateBtn.addEventListener('click', () => {
        secureLog('Add New Template button clicked.');
        sessionStorage.removeItem('templateEditorData'); // Ensure we start fresh for a new template
        document.body.classList.add('opacity-0', 'transition-opacity', 'duration-500');
        setTimeout(() => {
          location.href = 'template-editor.html'; // Redirect to the template editor page
        }, 300);
      });

      // === [3] Plugin slot handlers ===
      const pluginSlotTemplatesTop = document.getElementById('plugin-slot-templates-top');
      const pluginSlotTemplatesBottom = document.getElementById('plugin-slot-templates-bottom');

      if (window.AudioFormPlugin) {
        if (typeof window.AudioFormPlugin.renderTemplatesTop === 'function') {
          pluginSlotTemplatesTop.appendChild(window.AudioFormPlugin.renderTemplatesTop());
          secureLog('Plugin rendered in templates top slot.');
        }
        if (typeof window.AudioFormPlugin.renderTemplatesBottom === 'function') {
          pluginSlotTemplatesBottom.appendChild(window.AudioFormPlugin.renderTemplatesBottom());
          secureLog('Plugin rendered in templates bottom slot.');
        }
      }
      
      // === Debug Mode Integration ===
      if (isDebugMode) {
        console.log('🧪 DEBUG MODE ACTIVAT pentru Templates Page');
      }

      // Initial load of templates when the page loads
      loadTemplates();
    });
  </script>
</body>
</html>